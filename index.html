<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´¾å…‹å…¬æœƒä»»å‹™ä¸­å¿ƒ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --harry: #ef4444; --zoe: #10b981; --ian: #3b82f6; --chris: #f59e0b; }
        body { background-color: #f8fafc; font-family: -apple-system, "Microsoft JhengHei", sans-serif; padding-bottom: 50px; }
        .guild-header { background: #1e293b; color: white; padding: 20px 0; margin-bottom: 25px; border-radius: 0 0 20px 20px; }
        .section-title { font-weight: 700; color: #1e293b; margin: 25px 0 15px 0; border-left: 5px solid #6366f1; padding-left: 15px; }
        
        /* æˆå“¡èˆ‡é€²åº¦æ¢ */
        .member-column { background: #f1f5f9; border-radius: 16px; padding: 12px; height: 100%; border: 1px solid #e2e8f0; }
        .member-header { display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px; border-radius: 12px; color: white; font-weight: 800; }
        .progress-container { background: rgba(255,255,255,0.3); height: 8px; border-radius: 4px; margin-bottom: 15px; overflow: hidden; }
        .progress-fill { background: white; height: 100%; width: 0%; transition: width 1s ease-in-out; }

        /* ä»»å‹™å¡ç‰‡ */
        .task-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 12px; cursor: pointer; border: 1px solid #e2e8f0; transition: 0.2s; position: relative; }
        .task-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .task-title { font-size: 0.95rem; font-weight: 600; color: #334155; margin-bottom: 10px; }
        
        .status-select { font-size: 0.8rem; padding: 4px; border-radius: 5px; width: 100%; border: 1px solid #cbd5e1; }
        .sync-loader { font-size: 0.7rem; color: #6366f1; display: none; margin-top: 5px; text-align: right; }
        
        /* å¿«é€Ÿæ–°å¢æŒ‰éˆ• */
        .btn-add { background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 24px; height: 24px; line-height: 24px; text-align: center; cursor: pointer; }
        .btn-add:hover { background: rgba(255,255,255,0.4); }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner-border text-primary"></div>
        <p class="mt-3 fw-bold">æ­£åœ¨è®€å–æ´¾å…‹å…¬æœƒæ•¸æ“š...</p>
    </div>

    <div class="container-fluid guild-header text-center">
        <h2 class="mb-0">ğŸ›¡ï¸ æ´¾å…‹å…¬æœƒä»»å‹™ä¸­å¿ƒ</h2>
    </div>

    <div class="container">
        <h4 class="section-title">ä»»å‹™çœ‹æ¿</h4>
        <div class="row g-3">
            <div class="col-12 col-md-6 col-lg-3" id="col-harry">
                <div class="member-column">
                    <div class="member-header" style="background:var(--harry)">
                        <span>Harry</span>
                        <button class="btn-add" onclick="openAddModal('Harry')"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="progress-container"><div class="progress-fill" id="bar-harry"></div></div>
                    <div id="tasks-harry"></div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3" id="col-zoe"><div class="member-column"><div class="member-header" style="background:var(--zoe)"><span>Zoe</span><button class="btn-add" onclick="openAddModal('Zoe')"><i class="fas fa-plus"></i></button></div><div class="progress-container"><div class="progress-fill" id="bar-zoe"></div></div><div id="tasks-zoe"></div></div></div>
            <div class="col-12 col-md-6 col-lg-3" id="col-ian"><div class="member-column"><div class="member-header" style="background:var(--ian)"><span>Ian</span><button class="btn-add" onclick="openAddModal('Ian')"><i class="fas fa-plus"></i></button></div><div class="progress-container"><div class="progress-fill" id="bar-ian"></div></div><div id="tasks-ian"></div></div></div>
            <div class="col-12 col-md-6 col-lg-3" id="col-chris"><div class="member-column"><div class="member-header" style="background:var(--chris)"><span>Chris</span><button class="btn-add" onclick="openAddModal('Chris')"><i class="fas fa-plus"></i></button></div><div class="progress-container"><div class="progress-fill" id="bar-chris"></div></div><div id="tasks-chris"></div></div></div>
        </div>
    </div>

    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="m-title">ä»»å‹™è©³æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="m-body"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        const URL_TASKS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSLnU0BMgl4AFXJuTVBtdmcCvuhDbv7TJxLHGK0BQZ9pJTOxdcLQ2QU1inCjXeZKJdc9v3-y4Kfk4aS/pub?output=csv';
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyt0NrPGTDgXwMMnzWYnJrOM6XvoMVryZfBXdupggT1QR13BtG3UJb1TD4wWU_P_QA/exec';
        let allTasks = [];

        async function init() {
            try {
                const response = await fetch(URL_TASKS);
                const csvText = await response.text();
                Papa.parse(csvText, {
                    header: true,
                    complete: (results) => {
                        allTasks = results.data;
                        renderBoard();
                        document.getElementById('loading-overlay').style.display = 'none';
                    }
                });
            } catch (e) { console.error(e); }
        }

        function renderBoard() {
            const members = ['Harry', 'Zoe', 'Ian', 'Chris'];
            members.forEach(m => {
                const myTasks = allTasks.filter(t => (t['è² è²¬äºº']||'').includes(m));
                const unfinished = myTasks.filter(t => !(t['å®Œæˆæ—¥æœŸ']||'').trim());
                const finishedCount = myTasks.length - unfinished.length;
                const percent = myTasks.length > 0 ? (finishedCount / myTasks.length) * 100 : 0;
                
                // æ›´æ–°é€²åº¦æ¢
                document.getElementById(`bar-${m.toLowerCase()}`).style.width = percent + '%';
                
                const container = document.getElementById(`tasks-${m.toLowerCase()}`);
                container.innerHTML = unfinished.map((t, idx) => `
                    <div class="task-card" onclick="showDetail('${t['Task']}')">
                        <div class="task-title">${t['Task']}</div>
                        <div class="small text-muted mb-2"><i class="far fa-clock"></i> ${t['Deadline'] || '--'}</div>
                        <select class="status-select" onclick="event.stopPropagation()" onchange="updateStatus('${t['Task']}', this.value, this)">
                            <option value="Waiting" ${t['é€²åº¦']=='0%'?'selected':''}>â³ Waiting</option>
                            <option value="Working" ${t['é€²åº¦']!=='0%'&&t['é€²åº¦']!=='100%'?'selected':''}>ğŸš€ Working</option>
                            <option value="Finished">âœ… Finished</option>
                        </select>
                        <div class="sync-loader">åŒæ­¥ä¸­...</div>
                    </div>
                `).join('') || '<p class="text-center text-muted p-4">â˜• æš«ç„¡ä»»å‹™</p>';
            });
        }

        function showDetail(taskName) {
            const t = allTasks.find(x => x['Task'] === taskName);
            document.getElementById('m-title').innerText = t['Task'];
            document.getElementById('m-body').innerHTML = `
                <p><b>è² è²¬äºº:</b> ${t['è² è²¬äºº']}</p>
                <p><b>é¡åˆ¥:</b> ${t['Aspect'] || 'æœªåˆ†é¡'}</p>
                <p><b>æˆªæ­¢æ—¥:</b> ${t['Deadline']}</p>
                <p><b>ç•¶å‰é€²åº¦:</b> ${t['é€²åº¦']}</p>
                <hr>
                <p class="text-muted small">é€™ä»½è³‡æ–™ç›´æ¥å¾ Google Sheet è®€å–ã€‚</p>
            `;
            new bootstrap.Modal(document.getElementById('taskModal')).show();
        }

        function openAddModal(name) {
            const task = prompt(`ç‚º ${name} æ–°å¢ä»»å‹™åç¨±:`);
            if(task) updateStatus(task, "New", null, name);
        }

        async function updateStatus(taskName, status, el, owner = "") {
            if(el) {
                el.closest('.task-card').style.opacity = '0.5';
                el.nextElementSibling.style.display = 'block';
            }
            
            try {
                await fetch(GAS_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ task: taskName, status: status, owner: owner })
                });
                if(!el) alert('ä»»å‹™å·²æäº¤ï¼è«‹ç¨å€™ 5 åˆ†é˜å¾… Sheet æ›´æ–°ã€‚');
                else {
                    setTimeout(() => { alert('å·²å®ŒæˆåŒæ­¥ï¼'); location.reload(); }, 1000);
                }
            } catch (e) { alert('åŒæ­¥å¤±æ•—'); }
        }

        init();
    </script>
</body>
</html>
