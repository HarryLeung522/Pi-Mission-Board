<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´¾å…‹å…¬æœƒä»»å‹™çœ‹æ¿ - äº’å‹•ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --harry: #ef4444; --zoe: #10b981; --ian: #3b82f6; --chris: #f59e0b; }
        body { background-color: #f8fafc; font-family: -apple-system, "Microsoft JhengHei", sans-serif; padding-bottom: 50px; }
        .guild-header { background: #1e293b; color: white; padding: 20px 0; margin-bottom: 25px; border-radius: 0 0 20px 20px; }
        .section-title { font-weight: 700; color: #1e293b; margin: 25px 0 15px 0; border-left: 5px solid #6366f1; padding-left: 15px; }
        
        /* ä½ˆå±€ */
        .member-column { background: #f1f5f9; border-radius: 16px; padding: 12px; height: 100%; border: 1px solid #e2e8f0; }
        .member-header { padding: 12px; text-align: center; margin-bottom: 12px; border-radius: 12px; color: white; font-weight: 800; font-size: 1.2rem; }

        /* å°å¡ç‰‡æ¨£å¼ */
        .task-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; transition: 0.2s; position: relative; }
        .task-title { font-size: 1rem; font-weight: 600; color: #334155; margin-bottom: 10px; line-height: 1.4; }
        .task-meta { font-size: 0.75rem; color: #64748b; margin-bottom: 10px; display: flex; justify-content: space-between; }
        
        /* ä¸‹æ‹‰é¸å–® */
        .status-select { font-size: 0.85rem; padding: 6px; border-radius: 6px; border: 1px solid #cbd5e1; width: 100%; cursor: pointer; background-color: #fff; }
        .syncing { opacity: 0.5; pointer-events: none; }
        .sync-loader { font-size: 0.7rem; color: #6366f1; display: none; margin-top: 5px; text-align: right; }

        .event-item { background: white; border-radius: 12px; padding: 12px 20px; margin-bottom: 10px; border-left: 6px solid #1e293b; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner-border text-primary"></div>
        <p class="mt-3 fw-bold">æ­£åœ¨è®€å–æ´¾å…‹å…¬æœƒæ•¸æ“š...</p>
    </div>

    <div class="container-fluid guild-header text-center">
        <h2 class="mb-0">ğŸ›¡ï¸ æ´¾å…‹å…¬æœƒä»»å‹™çœ‹æ¿</h2>
    </div>

    <div class="container">
        <h4 class="section-title"><i class="fas fa-calendar-star text-danger"></i> é—œéµæ´»å‹•</h4>
        <div id="event-area" class="row g-2 mb-4"></div>

        <h4 class="section-title"><i class="fas fa-th-large text-primary"></i> ä»»å‹™çœ‹æ¿</h4>
        <div class="row g-3">
            <div class="col-12 col-md-6 col-lg-3"><div class="member-column"><div class="member-header" style="background:var(--harry)">Harry</div><div id="tasks-harry"></div></div></div>
            <div class="col-12 col-md-6 col-lg-3"><div class="member-column"><div class="member-header" style="background:var(--zoe)">Zoe</div><div id="tasks-zoe"></div></div></div>
            <div class="col-12 col-md-6 col-lg-3"><div class="member-column"><div class="member-header" style="background:var(--ian)">Ian</div><div id="tasks-ian"></div></div></div>
            <div class="col-12 col-md-6 col-lg-3"><div class="member-column"><div class="member-header" style="background:var(--chris)">Chris</div><div id="tasks-chris"></div></div></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        const URL_TASKS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSLnU0BMgl4AFXJuTVBtdmcCvuhDbv7TJxLHGK0BQZ9pJTOxdcLQ2QU1inCjXeZKJdc9v3-y4Kfk4aS/pub?output=csv';
        const URL_EVENTS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSLnU0BMgl4AFXJuTVBtdmcCvuhDbv7TJxLHGK0BQZ9pJTOxdcLQ2QU1inCjXeZKJdc9v3-y4Kfk4aS/pub?gid=1185871089&single=true&output=csv';
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyt0NrPGTDgXwMMnzWYnJrOM6XvoMVryZfBXdupggT1QR13BtG3UJb1TD4wWU_P_QA/exec';

        async function init() {
            try {
                const [tasks, events] = await Promise.all([
                    fetchData(URL_TASKS),
                    fetchData(URL_EVENTS)
                ]);
                renderEvents(events);
                renderTasks(tasks);
                document.getElementById('loading-overlay').style.display = 'none';
            } catch (e) { console.error(e); }
        }

        function fetchData(url) {
            return new Promise((res, rej) => {
                Papa.parse(url, { download: true, header: true, skipEmptyLines: true, complete: r => res(r.data), error: rej });
            });
        }

        // --- è‡ªå‹•åŒæ­¥åŠŸèƒ½ ---
        async function updateStatus(taskName, newStatus, selectElement) {
            const card = selectElement.closest('.task-card');
            const loader = card.querySelector('.sync-loader');
            
            // UI ç‹€æ…‹æ›´æ–°
            card.classList.add('syncing');
            loader.style.display = 'block';

            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    mode: 'no-cors', // é‡è¦ï¼šè§£æ±ºè·¨ç¶²åŸŸå•é¡Œ
                    cache: 'no-cache',
                    body: JSON.stringify({ task: taskName, status: newStatus })
                });

                // æ¨¡æ“¬å»¶é²ä»¥ä¾¿çœ‹åˆ°åŒæ­¥å‹•ç•«
                setTimeout(() => {
                    card.classList.remove('syncing');
                    loader.innerHTML = '<i class="fas fa-check"></i> å·²åŒæ­¥åˆ° Sheet';
                    setTimeout(() => { loader.style.display = 'none'; loader.innerHTML = 'åŒæ­¥ä¸­...'; }, 2000);
                }, 800);

            } catch (error) {
                alert('åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
                card.classList.remove('syncing');
            }
        }

        function renderEvents(data) {
            const container = document.getElementById('event-area');
            const today = new Date(); today.setHours(0,0,0,0);
            const filtered = data.filter(row => {
                const d = new Date(row['æ—¥æœŸ']?.replace(/å¹´|æœˆ/g, '/').replace(/æ—¥/g, ''));
                return d >= today;
            });

            container.innerHTML = filtered.map(e => `
                <div class="col-12 col-md-6">
                    <div class="event-item">
                        <div><div class="fw-bold">${e['Event']}</div><small class="text-muted">${e['æ—¥æœŸ']}</small></div>
                        <span class="badge bg-dark rounded-pill">é—œéµ</span>
                    </div>
                </div>
            `).join('') || '<p class="text-muted px-3">ç„¡è¿‘æœŸæ´»å‹•</p>';
        }

        function renderTasks(data) {
            const members = ['Harry', 'Zoe', 'Ian', 'Chris'];
            members.forEach(m => {
                const container = document.getElementById(`tasks-${m.toLowerCase()}`);
                const myTasks = data.filter(row => (row['è² è²¬äºº']||'').includes(m) && !(row['å®Œæˆæ—¥æœŸ']||'').trim());
                
                container.innerHTML = myTasks.map(t => {
                    const progress = t['é€²åº¦'] || '0%';
                    let selected = 'Waiting to start';
                    if(progress === '100%') selected = 'Finished';
                    else if(progress !== '0%') selected = 'Working';

                    return `
                        <div class="task-card">
                            <div class="task-meta">
                                <span class="badge bg-light text-secondary">${t['Aspect'] || 'General'}</span>
                                <span class="fw-bold text-danger">${t['Deadline'] || '--'}</span>
                            </div>
                            <div class="task-title">${t['Task']}</div>
                            <select class="status-select" onchange="updateStatus('${t['Task']}', this.value, this)">
                                <option value="Waiting to start" ${selected=='Waiting to start'?'selected':''}>â³ Waiting to start</option>
                                <option value="Working" ${selected=='Working'?'selected':''}>ğŸš€ Working (${progress})</option>
                                <option value="Finished" ${selected=='Finished'?'selected':''}>âœ… Finished</option>
                            </select>
                            <div class="sync-loader">åŒæ­¥ä¸­...</div>
                        </div>
                    `;
                }).join('') || '<p class="text-center text-muted p-4">â˜• æš«ç„¡ä»»å‹™</p>';
            });
        }

        init();
    </script>
</body>
</html>
